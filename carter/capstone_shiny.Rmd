---
title: "Climate Change Vulnerability in Oregon"
output:
  flexdashboard::flex_dashboard:
    theme:
      verson: 4
      bg: '#FFFFFF'
      fg: '#000000'
      primary: '#1A1A1A'
      navbar-bg: '#000000'
      base_font:
        google: Jost
      code_font:
        google: Noto Sans Mono
      heading_font:
        google: Jost
      font_scale: 1
    orientation: rows
    vertical_layout: fill
runtime: shiny
---

```{r global, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(dplyr)
library(stringr)
library(sf)
library(biscale)
library(cowplot)
library(ggiraph)
library(patchwork)

# Comments below are how to get from the CSV to the dataset needed for this proof-of-concept
# Only counties_sf, grouped_data, and metric_names are needed. The rest were removed before saving the .RData file.
# 
# library(readr)
# library(tigris)
# 
# federal_data <- read_csv("../data/climate_env_justice_screening_tool.csv")
# 
# oregon_data <- federal_data |>
#   filter(`State/Territory` == "Oregon")
# 
# selected_data <-
#   oregon_data |>
#   select(-where(is.logical),
#          -contains(c("percentile",
#                      "exceeded",
#                      "disadvantaged",
#                      "area",
#                      "adjusted",
#                      "proximity",
#                      "2009",
#                      "housing"),
#                    ignore.case = TRUE),
#          -`State/Territory`,
#          -`Percent age 10 to 64`,
#          -`Energy burden`,
#          -`Percent pre-1960s housing (lead paint indicator)`,
#          -`Wastewater discharge`,
#          -`Leaky underground storage tanks`,
#          -`Share of homes with no kitchen or indoor plumbing (percent)`,
#          -`Diagnosed diabetes among adults aged greater than or equal to 18 years`,
#          -`Median household income as a percent of area median income`,
#          -`Percent of residents who are not currently enrolled in higher ed`,
#          -`Percent two or more races`,
#          -`Percent other races`,
#          -`Life expectancy (years)`)
# 
# # metric_names <-
# #   selected_data |>
# #   as.data.frame() |>
# #   select(where(is.numeric)) |>
# #   names()
# 
# sens_options <-
#   selected_data |>
#   as.data.frame() |>
#   select(`Percent age under 10`,
#          `Percent age over 64`,
#          `Current asthma among adults aged greater than or equal to 18 years`:`Percent individuals age 25 or over with less than high school degree`) |>
#   names()
# 
# expo_options <-
#   selected_data |>
#   as.data.frame() |>
#   select(`Expected agricultural loss rate (Natural Hazards Risk Index)`:`Diesel particulate matter exposure`) |>
#   names()
# 
# demo_options <-
#   selected_data |>
#   as.data.frame() |>
#   select(`Percent Black or African American alone`:`Percent Hispanic or Latino`) |>
#   names()
# 
# grouped_data <-
#   selected_data |>
#   group_by(`County Name`)
# 
# counties_sf <- counties(state = "OR", year = 2010)
# 
# rm(federal_data)
# rm(oregon_data)
# rm(selected_data)
# 
# save.image(file = "../data/shiny_data.RData")

load("../data/shiny_data.RData")

layout <- "
#######################
##BBBB#################
##BBBB##AAAAAAAAAAAAAAA
##BBBB##AAAAAAAAAAAAAAA
##BBBB##AAAAAAAAAAAAAAA
CCCCCCCCAAAAAAAAAAAAAAA
CCCCCCCCAAAAAAAAAAAAAAA
CCCCCCCCAAAAAAAAAAAAAAA
CCCCCCCCAAAAAAAAAAAAAAA
CCCCCCCCAAAAAAAAAAAAAAA
CCCCCCCCAAAAAAAAAAAAAAA
CCCCCCCC###############
#######################
"
```

Column {.sidebar data-width=320}
=====================================

### Select metrics

```{r}
selectInput(inputId = "sensitivity",
            label = "Sensitivity",
            choices = sens_options,
            selected = "Percent age under 10")

selectInput(inputId = "exposure",
            label = "Exposure",
            choices = expo_options,
            selected = "PM2.5 in the air")

selectInput(inputId = "demographic",
            label = "Racial group",
            choices = demo_options,
            selected = "Percent White")
```

Preset comparisons

```{r}
actionButton(inputId = "preset1",
             label = "Children and PM2.5 pollution")
```

<br />

```{r}
actionButton(inputId = "preset2",
             label = "Poverty and building loss")
```

<br />

```{r}
actionButton(inputId = "preset3",
             label = "Linguistic isolation and wildfires")
```

<br />

Vulnerability
=====================================

Row
-----------------------------------------------------------------------

### {.no-title}
```{r}
observeEvent(input$preset1, {
  updateSelectInput(inputId = "sensitivity", selected = "Percent age under 10")
  updateSelectInput(inputId = "exposure", selected = "PM2.5 in the air")
  updateSelectInput(inputId = "demographic", selected = "Percent White")
})

observeEvent(input$preset2, {
  updateSelectInput(inputId = "sensitivity", selected = "Percent of individuals below 200% Federal Poverty Line")
  updateSelectInput(inputId = "exposure", selected = "Expected building loss rate (Natural Hazards Risk Index)")
  updateSelectInput(inputId = "demographic", selected = "Percent American Indian / Alaska Native")
})

observeEvent(input$preset3, {
  updateSelectInput(inputId = "sensitivity", selected = "Linguistic isolation (percent)")
  updateSelectInput(inputId = "exposure", selected = "Share of properties at risk of fire in 30 years")
  updateSelectInput(inputId = "demographic", selected = "Percent Hispanic or Latino")
})

renderGirafe({
  counties_summary <-
    grouped_data |>
    summarize(sens = weighted.mean(.data[[input$sensitivity]], `Total population`, na.rm = T),
              expo = weighted.mean(.data[[input$exposure]], `Total population`, na.rm = T),
              demo = weighted.mean(.data[[input$demographic]], `Total population`, na.rm = T)) |>
    mutate(scl1 = (sens - min(.data[["sens"]])) / (max(.data[["sens"]]) - min(.data[["sens"]])),
           scl2 = (expo - min(.data[["expo"]])) / (max(.data[["expo"]]) - min(.data[["expo"]])),
           vuln = (scl1 + scl2) / 2) |>
    left_join(counties_sf, by = c("County Name" = "NAMELSAD10")) |>
    st_as_sf()
  
  counties_bivar <-
    counties_summary |>
    bi_class(x = sens, 
             y = expo, 
             style = "quantile", 
             dim = 3)

  breaks <-
    counties_summary |>
    bi_class_breaks(x = sens,
                    y = expo, 
                    style = "quantile", 
                    dim = 3, 
                    split = TRUE)
  
  map <-
    counties_bivar |>
    ggplot(aes(fill = bi_class,
               tooltip = paste0(`County Name`, 
                                "\n", input$sensitivity, ": ", sens,
                                "\n", input$exposure, ": ", expo),
               data_id = `County Name`)) +
    geom_sf_interactive() +
    bi_scale_fill(pal = "PurpleOr") +
    bi_theme() +
    theme(legend.position = "none")
  
  scatter <-
    counties_bivar |>
    ggplot(aes(x = demo,
               y = vuln,
               color = bi_class,
               tooltip = paste0(`County Name`, 
                                "\n", input$demographic, ": ", demo,                                
                                "\n", input$sensitivity, ": ", sens,
                                "\n", input$exposure, ": ", expo))) +
    geom_point_interactive(alpha = 0.8,
                           size = 3) +
    bi_scale_color(pal = "PurpleOr") +
    labs(x = input$demographic, 
         y = "Combined vulnerability") +
    theme_minimal() +
    theme(legend.position = "none")
  
  legend <-
    bi_legend(pal = "PurpleOr",
              dim = 3,
              xlab = "Sensitivity",
              ylab = "Exposure",
              size = 10,
              breaks = breaks)

  girafe(ggobj = scatter + legend + map + plot_layout(design = layout), 
         width_svg = 11.5, 
         height_svg = 6.5,
         options = list(
           opts_selection(
             type = "single")
           )
         )
  },
  
  outputArgs = list(width = 1150, height = 650)
)
```

Single indicator
=====================================

```{r}

```
